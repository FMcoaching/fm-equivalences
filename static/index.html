<!doctype html>
<meta charset="utf-8">
<title>FM Équivalences</title>
<style>
  :root{--fg:#111;--muted:#666;--bg:#fff;--card:#fff;--border:#eaeaea}
  body{font:16px system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:24px;max-width:980px;color:var(--fg);background:var(--bg)}
  h1{margin:0 0 8px 0}
  .muted{color:var(--muted);font-size:14px}
  .tabs{display:flex;gap:10px;margin:18px 0}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:12px;cursor:pointer;background:#fafafa;user-select:none}
  .tab.active{background:#fff;border-color:#d9d9d9;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .card{border:1px solid var(--border);border-radius:14px;padding:16px;margin:10px 0;box-shadow:0 2px 6px rgba(0,0,0,.06);background:var(--card)}
  label{display:block;margin:6px 0 4px}
  input,select,button,textarea{font:inherit;padding:9px;border:1px solid var(--border);border-radius:10px}
  input[type=number]{width:120px}
  button{cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:1fr 120px 40px;gap:10px;align-items:center}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-1{display:grid;grid-template-columns:1fr;gap:10px}
  .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px}
  pre{background:#f8f8f8;padding:12px;border-radius:10px;overflow:auto}
  .foot{font-size:12px;color:#777;margin-top:8px}
  .ok{color:#0a7a2f}.warn{color:#b55b00}.err{color:#b00020}
</style>

<h1>Équivalences alimentaires (FM)</h1>
<div class="muted">Choisis un onglet : Équivalence simple ou Alternative repas complet.</div>

<div class="tabs">
  <div class="tab active" id="tab-simple">Équivalence simple</div>
  <div class="tab" id="tab-meal">Alternative repas complet</div>
</div>

<!-- ÉQUIVALENCE SIMPLE -->
<section class="card" id="view-simple">
  <h3>Équivalence simple</h3>
  <div class="row">
    <div>
      <label>Source (aliment)</label>
      <input id="s" placeholder="ex: Riz blanc à grains longs, cuit" list="s-dl">
      <datalist id="s-dl"></datalist>
    </div>
    <div>
      <label>Grammes (source)</label>
      <input id="g" type="number" min="1" value="100">
    </div>
  </div>
  <div class="row">
    <div>
      <label>Cible (aliment)</label>
      <input id="t" placeholder="ex: Spaghetti, cuit" list="t-dl">
      <datalist id="t-dl"></datalist>
    </div>
    <div>
      <label>Mode</label>
      <select id="m">
        <option value="carbs">Iso-glucides</option>
        <option value="kcal">Iso-kcal</option>
      </select>
    </div>
  </div>
  <button id="go">Calculer</button>
  <pre id="out"></pre>
</section>

<!-- ALTERNATIVE REPAS COMPLET -->
<section class="card" id="view-meal" style="display:none">
  <h3>Alternative repas complet</h3>

  <!-- Cibles & bouton -->
  <div class="grid-2">
    <div class="card">
      <h4>Cibles du repas</h4>
      <div class="grid-3" style="grid-template-columns:140px 1fr 1fr">
        <label>Protéines (g)</label><input id="tgP" type="number" min="1" value="30"><div></div>
        <label>Glucides (g)</label><input id="tgC" type="number" min="1" value="60"><div></div>
        <label>Lipides (g)</label><input id="tgF" type="number" min="1" value="15"><div></div>
      </div>
      <div class="foot">Entre des cibles &gt; 0 pour chaque macro.</div>
    </div>

    <div class="card">
      <h4>Calcul</h4>
      <button id="mix-calc">Calculer les grammes</button>
      <div id="mix-badge" class="foot" style="margin-top:8px"></div>
      <pre id="mix-out"></pre>
    </div>
  </div>

  <!-- Listes d’aliments par macro -->
  <div class="row">
    <div class="card">
      <h4>Protéines — aliments (max 3)</h4>
      <div id="prot-list" class="grid-1"></div>
      <button id="prot-add">+ Ajouter un aliment protéine</button>
    </div>

    <div class="card">
      <h4>Glucides — aliments (max 3)</h4>
      <div id="carb-list" class="grid-1"></div>
      <button id="carb-add">+ Ajouter un aliment glucides</button>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h4>Lipides — aliments (max 3)</h4>
      <div id="fat-list" class="grid-1"></div>
      <button id="fat-add">+ Ajouter un aliment lipides</button>
    </div>
  </div>

  <div class="foot">
    Ordre appliqué : <b>Protéines → Glucides → Réajust Protéines → Lipides</b>.<br>
    Si aucun budget de lipides n’est disponible, l’appli tente de <b>réduire automatiquement les glucides</b> pour libérer des calories.
  </div>
</section>

<script>
  // ---- UI Tabs ----
  const tabSimple = document.getElementById('tab-simple');
  const tabMeal   = document.getElementById('tab-meal');
  const viewSimple = document.getElementById('view-simple');
  const viewMeal   = document.getElementById('view-meal');

  function showSimple(){
    tabSimple.classList.add('active');
    tabMeal.classList.remove('active');
    viewSimple.style.display = 'block';
    viewMeal.style.display   = 'none';
    if (location.hash !== '#simple') history.replaceState(null,'','#simple');
  }
  function showMeal(){
    tabMeal.classList.add('active');
    tabSimple.classList.remove('active');
    viewMeal.style.display   = 'block';
    viewSimple.style.display = 'none';
    if (location.hash !== '#meal') history.replaceState(null,'','#meal');
  }
  tabSimple?.addEventListener('click', showSimple);
  tabMeal?.addEventListener('click', showMeal);
  if (location.hash === '#meal') { showMeal(); } else { showSimple(); }

  // ---- Autocomplete helper ----
  async function suggest(el, dlid){
    const q=el.value.trim(); if(q.length<3) return;
    const r=await fetch('/search?q='+encodeURIComponent(q));
    const j=await r.json();
    const dl=document.getElementById(dlid);
    dl.innerHTML=j.results.map(x=>`<option value="${x}">`).join('');
  }

  // ---- Simple equivalence ----
  document.getElementById('go').onclick=async ()=>{
    const body={source:s.value, grams:Number(g.value), target:t.value, mode:m.value};
    const r=await fetch('/equivalence',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const j=await r.json();
    out.textContent = JSON.stringify(j, null, 2);
  };

  // --- helpers pour les lignes d'aliments par macro ---
  function addFoodRow(containerId){
    const cont = document.getElementById(containerId);
    const i = cont.querySelectorAll('input').length;
    if(i >= 3){ alert('Maximum 3 aliments par macro'); return; }
    const wrap = document.createElement('div');
    wrap.className='grid-3';
    wrap.innerHTML = `
      <input placeholder="Aliment #${i+1}" list="${containerId}-dl-${i}" />
      <datalist id="${containerId}-dl-${i}"></datalist>
      <button type="button" aria-label="Supprimer">×</button>
    `;
    cont.appendChild(wrap);
    const input = wrap.querySelector('input');
    const dlid  = `${containerId}-dl-${i}`;
    input.addEventListener('input', e => suggest(e.target, dlid));
    wrap.querySelector('button').onclick = ()=> cont.removeChild(wrap);
  }

  // Boutons + initialisation: 1 champ par macro au chargement
  document.getElementById('prot-add').onclick = ()=> addFoodRow('prot-list');
  document.getElementById('carb-add').onclick = ()=> addFoodRow('carb-list');
  document.getElementById('fat-add').onclick  = ()=> addFoodRow('fat-list');
  ['prot-list','carb-list','fat-list'].forEach(id=> addFoodRow(id));

  // Collecte des aliments d’un bloc
  function collectFoods(containerId){
    return Array.from(document.querySelectorAll(`#${containerId} input`))
      .map(el => el.value.trim())
      .filter(Boolean)
      .slice(0,3);
  }

  // --- Calcul /mix-plan ---
  document.getElementById('mix-calc').onclick = async ()=>{
    const tgP = Number(document.getElementById('tgP').value||0);
    const tgC = Number(document.getElementById('tgC').value||0);
    const tgF = Number(document.getElementById('tgF').value||0);
    if(tgP<=0 || tgC<=0 || tgF<=0){
      alert('Entre des cibles > 0 pour Protéines, Glucides et Lipides.');
      return;
    }

    const foods = {
      protein: collectFoods('prot-list'),
      carb:    collectFoods('carb-list'),
      fat:     collectFoods('fat-list'),
    };
    if(foods.protein.length===0 || foods.carb.length===0 || foods.fat.length===0){
      alert('Ajoute au moins 1 aliment dans chaque macro.');
      return;
    }

    const body = { targets: { prot_g: tgP, carb_g: tgC, fat_g: tgF }, foods, round_to: 5 };
    let resp, json;
    try{
      resp = await fetch('/mix-plan', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      json = await resp.json();
    }catch(e){
      document.getElementById('mix-badge').textContent = '';
      document.getElementById('mix-out').textContent = '❌ Erreur réseau.';
      return;
    }

    const badge = document.getElementById('mix-badge');
    badge.textContent = '';
    if(!resp.ok){
      const msg = (json && (json.detail?.error || json.error)) || 'Demande impossible';
      badge.textContent = '❌ ' + msg;
      document.getElementById('mix-out').textContent = JSON.stringify(json, null, 2);
      return;
    }

    const lines = [];
    const t = json.targets || {};
    const ft = json.final_totals || {};
    if(json.suggested_recipe){
      lines.push('Recette proposée :');
      json.suggested_recipe.forEach(it => lines.push(`- ${it.aliment}: ${it.grams} g`));
      lines.push('');
    }
    if(ft.kcal !== undefined){
      lines.push(`Totaux estimés : Prot ${ft.prot_g} g, Gluc ${ft.carb_g} g, Lip ${ft.fat_g} g, Kcal ${ft.kcal}`);
    }
    if(t.kcal_expected !== undefined){
      lines.push(`Kcal attendues d’après cibles : ${t.kcal_expected}`);
    }

    // Badge "écarts" simple
    const dP = Math.round((t.prot_g - (ft.prot_g||0)) * 10)/10;
    const dC = Math.round((t.carb_g - (ft.carb_g||0)) * 10)/10;
    const dF = Math.round((t.fat_g  - (ft.fat_g ||0)) * 10)/10;
    const ok = Math.abs(dP)<=0.5 && Math.abs(dC)<=0.5 && Math.abs(dF)<=0.5;
    badge.textContent = ok ? '✅ Cibles atteintes (arrondi au pas 5 g).'
                           : `⚠️ Écarts restants — Prot ${dP} g, Gluc ${dC} g, Lip ${dF} g`;

    document.getElementById('mix-out').textContent = lines.join('\n') + '\n\n' + JSON.stringify(json, null, 2);
  };
</script>
